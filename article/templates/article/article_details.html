{% extends 'home/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %} Create Article {% endblock title %}
{% block page_specific_css %}
<style>
    .solid {
        color: rgb(223, 81, 81);
    }
    .note_header_row{
        margin: 0.5em;
    }
    .exp_column{
        border: .2em solid;
        padding: .2em;
    }
    .note_add_button{
        width: fit-content; 
        height: 2.5em; 
        line-height: 2.5em; 
        padding: 0 1.25em;
    }

</style>
{% endblock page_specific_css %}

{% block body %}

<section>

    <header class="main">
        <h2>{{ object.title }}</h2>
    </header>

    <hr class="major">
    <div class="row">
        <div id="div_content" class="col-8 p-1">
            <div id="content">
                {{ object.content|safe }}
            </div>
        </div>
        <div class="col-4 mb-3" style="position: -webkit-sticky;
        position: sticky; top: 0; height: fit-content;  min-height: 200px;">
            <div class="col exp_column">
                <h3>Meaning</h3>
                <div id="meanings">
    
                </div>
                
            </div>
            <div class="col mt-3 exp_column">
                <div class="row note_header_row">
                    <div class="col-6" style="text-align: center;">
                        <h3 style="width: fit-content;">Note</h3>
                    </div>
                    <div class="col-6" style="text-align: center;">
                        <button class="button secondary note_add_button" data-bs-toggle="modal" data-bs-target="#noteModal">
                            Add
                        </button>
                    </div>
                </div>
                
                <div class='col' id="note">
    
                </div>
                
            </div>
        </div>
        
        
    </div>
</section>

<!-- Vertically centered modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="noteModalLabel">Create Note</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>

			<div class="modal-body">
				<form action="{% url 'article:note_create' article_id=object.id %}" method="post">
					{% csrf_token %}
                    <div>
                        <input type="text" name="word" id="word" value="" placeholder="Word">
                    </div>
                    <div class="mt-3">
                        <input type="text" name="content" id="content" value="" placeholder="Content">
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="button secondary">Create</button>
                    </div>
			    </form>
			</div>


		<div class="modal-footer">
		  <button type="button" class="button primary" data-bs-dismiss="modal">Close</button>
		</div>
	  </div>
	</div>
</div>

{{ object.id|json_script:"article_id" }}
{{ favourite_word_list|json_script:"favourite_word_list" }}
{{ note_list|json_script:"note_list" }}
{{ meaning_list|json_script:"meaning_list" }}
<div id="get_word_meaning_url" data-get-word-meaning-url="{% url 'get_word_meaning' %}" type="hidden"></div>
<div id="get_note_url" data-get-note-url="{% url 'article:get_note' %}" type="hidden"></div>
<div id="set_favourite_url" data-set-favourite-url="{% url 'article:set_favourites' %}" type="hidden"></div>

{% endblock body %}

{% block page_specific_js %}
<script src="{% static 'js/base.js'%}"></script>
<script>

    // function getMeaning(e) {
    //     let data = window.getSelection().toString();
    //     // console.log(document.selection.createRange().text);
    //     console.log(data);
    // }
    var article_details = function () {

        let article_id=JSON.parse(document.getElementById('article_id').textContent);
        let meaning_list=JSON.parse(document.getElementById('meaning_list').textContent);

        function getMeaning(e) {
            e.preventDefault();
            let word = window.getSelection().toString();
            document.getElementById('word').value=word;
            // console.log(word);
            if (word) {
                const data = {
                    'word': word,
                };
                // console.log(data)
                const url = document.getElementById('get_word_meaning_url').getAttribute("data-get-word-meaning-url");
                fetch(url, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": base.csrftoken,
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    let meaning_div =document.getElementById('meanings');
                    meaning_div.innerHTML = '';
                    const meanings = data.context.meanings;
                    if (meanings){
                        for (let i=0; i<meanings.length; i++){
                            let icon_class;
                            if (article_details.meaning_list.includes(meanings[i].k_ele)){
                                icon_class = 'icon fa-regular fa-star solid';
                            } else{
                                icon_class = 'icon fa-regular fa-star'
                            }
                            let meaning_content_div = document.createElement('div');
                            meaning_content_div.className = 'row';

                            let heading_div = document.createElement('div');
                            heading_div.className = 'col-9';
                            let heading = document.createElement('h3');
                            heading.innerText = meanings[i].k_ele;
                            heading_div.appendChild(heading);

                            let icon_div = document.createElement('div');
                            icon_div.className = 'col-3';
                            let selected_word_p = document.createElement('p');
                            selected_word_p.innerText = meanings[i].k_ele+'&'+word;
                            selected_word_p.style.display='none';

                            let checkebox = document.createElement('span');
                            checkebox.style.float = 'left';
                            checkebox.innerHTML = "<i class='"+icon_class+"' style='font-size: 1.7rem;'"+
                            "onClick='article_details.makeFavourite(this);'></i>";
                            icon_div.appendChild(selected_word_p);
                            icon_div.appendChild(checkebox);

                            meaning_content_div.appendChild(heading_div);
                            meaning_content_div.appendChild(icon_div);

                            let sub_heading = document.createElement('h5');
                            sub_heading.innerText = meanings[i].r_ele

                            senses = meanings[i].sense
                            let def_list = document.createElement('ol')
                            for (let j=0; j<senses.length; j++){
                                let list = document.createElement('li');
                                let def_div = document.createElement('div');
                                def_div.className = 'col p-1';
                                let desc_div = document.createElement('div');
                                let desc_span = document.createElement('span');
                                desc_span.style.fontSize = '1.25rem';
                                let word_meaning = senses[j].meaning.toString();
                                desc_span.innerHTML = word_meaning.replace(/,/g, ', ');
                                desc_div.appendChild(desc_span);
                                let pos_div = document.createElement('div');
                                let pos_span = document.createElement('span');
                                pos_span.style.fontSize = '0.9rem'
                                let word_pos = senses[j].pos.toString();
                                pos_span.innerHTML = word_pos.replace(/,/g, ', ');
                                pos_div.appendChild(pos_span);
                                def_div.appendChild(desc_div);
                                def_div.appendChild(pos_div);
                                list.appendChild(def_div);
                                def_list.appendChild(list);
                            }
                            meaning_div.appendChild(meaning_content_div);
                            meaning_div.appendChild(sub_heading);
                            meaning_div.appendChild(def_list);

                            let note_div =document.getElementById('note');
                            note_div.innerHTML = '';
                        }
                    }else{
                        article_details.getNote(e, word);
                    }

                })
                .catch((error) => {
                    console.error('Error:', error);
                    message = "問題が起こりました。もう一度お願いします。";
                    // base.alert_message(message);
                    console.log(message);
                    return;
                });
            }
        }

        function getNote(e, word) {
            e.preventDefault();
            if (word) {
                const data = {
                    'article_id':article_id,
                    'word': word,
                };
                // console.log(data)
                const url = document.getElementById('get_note_url').getAttribute("data-get-note-url");
                fetch(url, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": base.csrftoken,
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    let note_div =document.getElementById('note');
                    note_div.innerHTML = '';
                    const content = data.context.content;
                    if (content){
                        let note_content_div = document.createElement('div');
                        let heading = document.createElement('h3');
                        heading.innerText = word;
                        let span = document.createElement('span');
                        span.innerText = content;
                        note_content_div.appendChild(heading);
                        note_content_div.appendChild(span);
                        note_div.appendChild(note_content_div);
                    }else{
                        let meaning_div =document.getElementById('meanings');
                        meaning_div.innerHTML = '<p>There is no meaning to the selected part.'
                            +'Please try selecting the word before or after the selected part.'+
                            'Otherwise, you can add a note for this word.</p>';
                        document.getElementById('word').value = word;
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                    message = "問題が起こりました。もう一度お願いします。";
                    // base.alert_message(message);
                    console.log(message);
                    return;
                });
            }
        }

        function makeFavourite(checkbox){
            checkbox.classList.toggle('solid');
            // console.log('Fvadjdf');
            let article_id = JSON.parse(document.getElementById('article_id').textContent);
            let favourite_text = checkbox.parentNode.previousSibling.innerText.split('&');
            let favourite_meaning = favourite_text[0];
            let selected_text = favourite_text[1];
            // console.log(favourite_meaning, selected_text);
            const data = {
                'article_id': article_id,
                'selected_word':selected_text,
                'meaning':favourite_meaning,
            };
            const url = document.getElementById('set_favourite_url').getAttribute("data-set-favourite-url");
            fetch(url, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": base.csrftoken,
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // console.log('success');
                location.reload();
            })
            .catch((error) => {
                // console.error('Error:', error);
                message = "問題が起こりました。もう一度お願いします。";
                // base.alert_message(message);
                // console.log(message);
                return;
            });

        }

        return {
            meaning_list,meaning_list,
            getMeaning: getMeaning,
            makeFavourite:makeFavourite,
            getNote:getNote
        }
    }();

    document.onmouseup = article_details.getMeaning;

    window.onload = function () {
        let favourite_word_list = JSON.parse(document.getElementById('favourite_word_list').textContent);
        let note_list = JSON.parse(document.getElementById('note_list').textContent);
        let content_div = document.getElementById('div_content')
        let content = document.getElementById('content').innerHTML;
        let marked_word = [];
        for (let i=0; i<favourite_word_list.length; i++){
            let marked_index = marked_word.findIndex(element => element.includes(favourite_word_list[i]));
            if (marked_index==-1){
                content = content.replaceAll(favourite_word_list[i],
                "<span style='color:SteelBlue;'>"+favourite_word_list[i]+"</span>&nbsp;");
                marked_word.push(favourite_word_list[i]);
            }
            
        }
        for (let i=0; i<note_list.length; i++){
            let marked_index = marked_word.findIndex(element => element.includes(note_list[i]));
            if (marked_index==-1){
                content = content.replaceAll(note_list[i],
                "<span style='color:CadetBlue;'>"+note_list[i]+"</span>&nbsp;");
                marked_word.push(note_list[i]);
            }
        }
        content_div.innerHTML=content;
    };

</script>

{% endblock page_specific_js %}
